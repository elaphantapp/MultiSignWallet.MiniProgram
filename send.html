<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Send</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.10/dist/vue.js"></script>
    <script src="https://cdn.bootcss.com/jquery/3.4.1/jquery.js"></script>
    <script src="https://cdn.bootcss.com/lodash.js/4.17.12-pre/lodash.min.js"></script>
    <script src="./js/vue-clipboard.min.js"></script>
</head>
<style type="text/css">
    .fl {
        float: left;
    }
    
    .fr {
        float: right;
    }
    
    html,
    body,
    div,
    span,
    applet,
    object,
    iframe,
    h1,
    h2,
    h3,
    h4,
    h5,
    h6,
    p,
    blockquote,
    pre,
    a,
    abbr,
    acronym,
    address,
    big,
    cite,
    code,
    del,
    dfn,
    em,
    img,
    ins,
    kbd,
    q,
    s,
    samp,
    small,
    strike,
    strong,
    sub,
    sup,
    tt,
    var,
    b,
    u,
    i,
    center,
    dl,
    dt,
    dd,
    ol,
    ul,
    li,
    fieldset,
    form,
    label,
    legend,
    table,
    caption,
    tbody,
    tfoot,
    thead,
    tr,
    th,
    td,
    article,
    aside,
    canvas,
    details,
    embed,
    figure,
    figcaption,
    footer,
    header,
    hgroup,
    menu,
    nav,
    output,
    ruby,
    section,
    summary,
    time,
    mark,
    audio,
    video {
        margin: 0;
        padding: 0;
        border: 0;
        font-size: 100%;
        font: inherit;
        vertical-align: baseline;
    }
    /* HTML5 display-role reset for older browsers */
    
    article,
    aside,
    details,
    figcaption,
    figure,
    footer,
    header,
    hgroup,
    menu,
    nav,
    section {
        display: block;
    }
    
    body {
        line-height: 1;
        background: #f0eff5;
    }
    
    ol,
    ul {
        list-style: none;
    }
    
    blockquote,
    q {
        quotes: none;
    }
    
    blockquote:before,
    blockquote:after,
    q:before,
    q:after {
        content: '';
        content: none;
    }
    
    table {
        border-collapse: collapse;
        border-spacing: 0;
    }
    /* add */
    
    body {
        font-size: 12px;
        margin: 0;
        padding: 0;
        font-family: Arial, "微软雅黑";
    }
    
    body,
    html {
        height: 100%;
    }
    
    img {
        border: 0
    }
    
    h1,
    h2,
    h3,
    h4,
    h5,
    h6 {
        font-size: 100%;
        font-weight: normal;
    }
    
    select,
    input {
        vertical-align: middle
    }
    
    .clear {
        display: block !important;
        clear: both !important;
        float: none !important;
        margin: 0 !important;
        padding: 0 !important;
        height: 0;
        line-height: 0;
        font-size: 0;
        overflow: hidden;
    }
    
    .clearfix {
        zoom: 1;
    }
    
    .clearfix:after {
        content: "";
        display: block;
        clear: both;
        height: 0;
    }
    
    .spacer {
        clear: both;
        font-size: 0;
        height: 0;
        line-height: 0;
    }
    
    a {
        color: #333;
        text-decoration: none
    }
    
    a:hover {
        color: #f00;
    }
    
    img,
    input,
    label {
        vertical-align: middle;
    }
    
    body {
        background: #E5E5E5;
    }
    
    #app {
        position: relative;
        padding: 15px 10px;
    }
    
    .four {
        width: 220px;
        margin: 0 auto;
        text-align: center;
    }
    
    .four p {
        font-family: Bio Sans;
        font-size: 16px;
        margin-top: 50px;
        width: 220px;
        line-height: 44px;
        height: 44px;
        background: #0070C8;
        border-radius: 200px;
        color: #FFFFFF;
    }
    
    .five {
        margin: 0 auto;
        width: 252px;
        margin-top: 10px;
        font-family: Bio Sans;
        font-size: 12px;
        color: #888888;
        text-align: center;
    }
    
    .five p {
        width: 252px;
        word-wrap: break-word;
        word-break: normal;
        white-space: normal;
        line-height: 17px;
    }
    
    .first {
        padding: 15px;
        height: 216px;
        background: #FFFFFF;
        box-shadow: 0px 2px 10px rgba(106, 147, 205, 0.1);
        border-radius: 5px;
    }
    
    .first .title {
        height: 15px;
        font-family: Bio Sans;
        font-size: 12px;
        line-height: 15px;
        display: flex;
        align-items: center;
        color: #000000;
    }
    
    .first .hang textarea {
        margin: 10px 0px;
        padding-bottom: 5px;
        display: inline-block;
        width: 100%;
        height: 17px;
        font-family: Bio Sans;
        font-size: 14px;
        line-height: 17px;
        align-items: center;
        color: #DADADA;
        border: 0;
        outline: none;
        border-bottom: 1px solid #DADADA;
        resize: none;
        vertical-align: middle;
    }
    
    .first .hang input {
        margin: 10px 0px;
        padding-bottom: 5px;
        display: inline-block;
        width: 100%;
        height: 17px;
        font-family: Bio Sans;
        font-size: 14px;
        line-height: 17px;
        align-items: center;
        color: #DADADA;
        border: 0;
        outline: none;
        border-bottom: 1px solid #DADADA;
    }
    
    .tip {
        height: 15px;
        font-family: Bio Sans;
        font-size: 12px;
        line-height: 15px;
        align-items: center;
        color: #888888;
        text-align: right;
        margin-top: 30px;
    }
    
    .paste {
        width: 48px;
        height: 20px;
        left: 297px;
        top: 143px;
        font-family: Bio Sans;
        font-size: 14px;
        line-height: 17px;
        display: flex;
        align-items: center;
        text-align: center;
        color: #0070C8;
        border: 1px solid #0070C8;
        box-sizing: border-box;
        border-radius: 20px;
    }
    
    .toast {
        position: fixed;
        z-index: 2000;
        left: 50%;
        top: 25%;
        transition: all .5s;
        -webkit-transform: translateX(-50%) translateY(-50%);
        -moz-transform: translateX(-50%) translateY(-50%);
        -ms-transform: translateX(-50%) translateY(-50%);
        -o-transform: translateX(-50%) translateY(-50%);
        transform: translateX(-50%) translateY(-50%);
        text-align: center;
        border-radius: 5px;
        color: #FFF;
        background: rgba(17, 17, 17, 0.7);
        height: 45px;
        line-height: 45px;
        padding: 0 15px;
        width: 200px;
    }
    
    .bg {
        height: 190px;
        left: 0px;
        top: 0px;
        background: #0070C8;
        box-shadow: 0px 2px 10px rgba(106, 147, 205, 0.1);
        border-radius: 5px;
    }
    
    [v-cloak] {
        display: none;
    }
</style>

<body>
    <div id="app" class="bg" v-cloak>
        <div class="toast" v-show="toastShow">
            {{toastText}}
        </div>
        <div class="first">
            <p class="title">{{curLangule["key17"]}}</p>
            <div class="hang">
                <span style="display:inline-block;width: 82%"><textarea :placeholder="curLangule['key18']" v-model="elaAdress"></textarea></span>
                <span style="display:inline-block;width: 15%" class="paste" v-on:click="doCopy">{{curLangule["key5"]}}</span>
            </div>
            <p class="title">{{curLangule["key19"]}}</p>
            <div class="hang">
                <span style="display:inline-block;width: 60%"><input :placeholder="curLangule['key20']" v-model="amount" /></span>
                <span style="display:inline-block;width: 37%">{{curLangule["key30"]}}：{{balance['num']}}</span>
            </div>
            <p class="title">{{curLangule["key21"]}}</p>
            <div class="hang">
                <input :placeholder="curLangule['key22']" v-model="memo" />
            </div>
            <p class="tip">{{curLangule["key23"]}}0.0000486 ELA</p>
        </div>
        <div class="four" v-on:click="send">
            <p>{{curLangule["key24"]}}</p>
        </div>

        <div class="five">
            <p v-if="curLanguleKey ==='zh'">需要至少{{walletList['requiredCount']}}个(一共{{walletList["totalPublic"]}}个) 批准才可以完成这笔花费</p>
            <p v-if="curLanguleKey ==='en'">{{walletList['requiredCount']}} out of {{walletList["totalPublic"]}} approvals are required to complete this transaction.</p>
        </div>
    </div>
</body>
<script>
    var app = new Vue({
        el: '#app',
        data: {
            loading: true,
            zh: {
                key5: '复制',
                key17: '发送至',
                key18: 'ELA接收地址',
                key19: '金额',
                key20: 'ELA金额',
                key21: '备注（可选）',
                key22: '备注',
                key23: '矿工费: ',
                key24: '发送',
                key25: '方中的',
                key26: '方批准了才能完成这次交易。',
                error5: '请输入ELA接收地址',
                error6: '请输入ELA金额',
                error7: '请输入正确的金额',
                error8: '余额不足',
                error9: '地址不合法',
                error10: 'Memo 不能超过250字符',
                key29: '复制成功',
                key30: '余额',
            },
            en: {
                key5: 'copy',
                key17: 'Send to',
                key18: 'ELA receive address',
                key19: 'Amount',
                key20: 'Amount of ELA',
                key21: 'Memo (optional)',
                key22: 'memo',
                key23: 'Miner Fee: ',
                key24: 'Send',
                key25: 'out of',
                key26: 'approvals are required to complete this transaction.',
                error5: 'Please enter ELA receive address',
                error6: 'Please enter the amount of ELA',
                error7: 'Wrong Amount',
                error8: 'The balance is not enough',
                error9: 'Illegal address',
                error10: "Memo can't be more than 250 characters",
                key29: 'Copy Success',
                key30: 'Balance',

            },
            curLangule: {},
            schemeConfig: {
                "AppID": "f4d54cd97afa828a9705e38eb679fad564cf3adf4cecd1a5503498155969b07baaa4c4a016084c0f21e06c59e76c33929925052d7d0ae3cfc679a0fdf48ec23f",
                "AppName": "ELA Multi-sig Wallet",
                "DID": "ipFFpL1JwPRQKfhmxak8r1wWEbdkJ3rXZu",
                "PublicKey": "035731ff69f8cfdcd9881e573143d71de2390b2e8e71fa14729e6b506f5d74939d",
                "Tx": "",
                "ReturnUrl": "",
            },
            curLanguleKey: 'zh',
            elaAdress: "",
            amount: "",
            memo: "",
            fee: {
                "num": 0
            },
            sela: 100000000,
            address: '',
            toastShow: false,
            toastText: '',
            balance: {
                'num': 0
            },
            walletList: {}
        },
        methods: {
            getLen2(str) {　　　　 //将中文替换成两个英文字符来统计
                return str.replace(/[^\x00-\xff]/g, "aa").length;
            },
            getBalance(address) {
                return new Promise((resovle, reject) => {
                    $.ajax({
                        url: 'https://node1.elaphant.app/api/1/balance/' + address,
                        dataType: 'json',
                        contentType: 'application/json',
                        type: 'GET',
                        success: function(data) { //成功回调函数
                            resovle(data);
                        },
                        error: function(err) { //失败回调函数
                            reject(err);
                        }
                    });


                })
            },
            toast(str) {
                var v = this;
                v.toastText = str
                v.toastShow = true
                setTimeout(function() {
                    v.toastShow = false
                }, 1500)
            },
            getLanugle: function() {
                this.curLangule = this.en;
                this.curLanguleKey = 'en';
                var JsSrc = (navigator.language || navigator.browserLanguage).toLowerCase();
                if (JsSrc.indexOf('zh') >= 0) {
                    // 假如浏览器语言是中文
                    this.curLanguleKey = 'zh';
                    this.curLangule = this.zh;
                } else if (JsSrc.indexOf('en') >= 0) {
                    this.curLangule = this.en;
                    this.curLanguleKey = 'en';
                } else {
                    // 假如浏览器语言是其它语言
                    this.curLangule = this.en;
                    this.curLanguleKey = 'en';
                }
            },
            accMul(arg1, arg2) {
                var m = 0,
                    s1 = arg1.toString(),
                    s2 = arg2.toString();
                try {
                    m += s1.split(".")[1].length;
                } catch (e) {}
                try {
                    m += s2.split(".")[1].length;
                } catch (e) {}
                return Number(s1.replace(".", "")) * Number(s2.replace(".", "")) / Math.pow(10, m);
            },
            send() {
                if (this.checkParm()) {
                    var v = this;
                    this.getTx().then((data) => {

                        if (data.status === 200) {
                            var url = v.buildMultiTx(data.result);
                            location.href = url;
                            //location.href = 'http://dev1.elapps.net/history.html?' + 'Address=' + this.address;
                        }
                    }).catch((err => {

                    }));
                }

            },
            buildMultiTx(tx) {

                if (this.memo != "") {
                    var msg = "type:text,msg:";
                    tx.Transactions[0].Memo = msg + this.memo;
                }
                var txJson = JSON.stringify(tx);
                this.schemeConfig['Tx'] = txJson;
                this.schemeConfig['ReturnUrl'] = 'http://dev1.elapps.net/history.html?' + 'Address=' + this.address;
                var url = "elaphant://multitx?";
                var that = this;
                _.forEach(this.schemeConfig, function(val, key, index) {

                    if (key === 'ReturnUrl') {
                        val = encodeURIComponent(val);
                    } else if (key === 'Tx') {
                        val = encodeURIComponent(val);
                    }
                    if (key === 'ReturnUrl') {
                        url += key + '=' + val;
                    } else {
                        url += key + '=' + val + '&';
                    }
                });
                return url;
            },
            getTx() {
                var parms = {
                    inputs: [this.address],
                    outputs: [{
                        addr: this.elaAdress,
                        amt: this.accMul(this.amount, this.sela)
                    }]
                }
                return new Promise((resovle, reject) => {
                    $.ajax({
                        url: 'https://node1.elaphant.app/api/1/createVoteTx',
                        dataType: 'json',
                        contentType: 'application/json',
                        type: 'POST',
                        data: JSON.stringify(parms),
                        success: function(data) { //成功回调函数
                            resovle(data);
                        },
                        error: function(err) { //失败回调函数
                            reject(err);
                        }
                    });


                })
            },
            getUrlParam: function(name) {
                //正则表达式过滤
                var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
                //正则规则
                var r = window.location.search.substr(1).match(reg);

                if (r != null) return decodeURI(r[2]);
                return null;
            },
            search() {
                // if (this.amount > 0) {
                //     this.getTx().then((res) => {
                //         if (res.status != 200) {
                //             this.$set(this.fee, 'num', 0);
                //             return;
                //         }
                //         var data = res.result || {};
                //         var Transactions = data.Transactions || [];
                //         var fee = this.div(Transactions[0].Fee, this.sela);
                //         this.$set(this.fee, 'num', fee);
                //     }).catch(() => {

                //     });
                // } else {
                //     this.$set(this.fee, 'num', 0);
                // }
            },
            div: function(a, b) {
                var c, d, e = 0,
                    f = 0;
                try {
                    e = a.toString().split(".")[1].length;
                } catch (g) {}
                try {
                    f = b.toString().split(".")[1].length;
                } catch (g) {}
                return c = Number(a.toString().replace(".", "")), d = Number(b.toString().replace(".", "")), this.accMul(c / d, Math.pow(10, f - e));
            },
            checkParm() {
                if (this.elaAdress === "") {
                    this.toast(this.curLangule['error5'])
                    return false;
                }
                var isOK = !this.isAddressValid(this.elaAdress);
                if (isOK) {
                    this.toast(this.curLangule['error9'])
                    return false;
                }
                if (this.amount === "") {
                    this.toast(this.curLangule['error6'])
                    return false;
                }

                if (!this.number(this.amount)) {
                    this.toast(this.curLangule['error7'])
                    return false;
                }

                if (this.amount <= 0) {
                    this.toast(this.curLangule['error7'])
                    return false;
                }

                if (this.amount > this.balance['num']) {
                    this.toast(this.curLangule['error8']);
                    return;
                }

                if (this.amount.toString().indexOf(".") > -1 && this.amount.toString().split(".")[1].length > 8) {
                    this.toast(this.curLangule['error7'])
                    return false;
                }

                if (this.getLen2(this.memo) >= 250) {
                    this.toast(this.curLangule['error10'])
                    return false;
                }

                return true;
            },
            number(text) {
                var numPattern = /^(([1-9]\d*)|\d)(\.\d{1,9})?$/;
                return numPattern.test(text);
            },
            doCopy() {
                var v = this;
                this.$copyText(this.elaAdress).then(function(e) {
                    v.toast(v.curLangule['key29']);
                }, function(e) {})
            },
            isAddressValid(address) {
                var r = false;
                if (address.length != 34) {
                    return r
                }

                r = (address[0] == 'E' || address[0] == 'i' ||
                    address[0] == '8' || address[0] == 'X' || address[0] == 'D')

                if (r == false && address === "1111111111111111111114oLvT2") {
                    r = true;
                }

                return r;
            }
        },
        mounted: function() {
            // `this` 指向 vm 实例
            this.getLanugle();
            this.address = this.getUrlParam("Address");
            var walletList = localStorage.getItem('ELA-Multi-sig-Wallet') || "";
            this.walletList = JSON.parse(walletList)[this.address];
            this.getBalance(this.address).then((res) => {
                if (res.status === 200) {
                    this.$set(this.balance, 'num', res.result);
                } else {
                    this.$set(this.balance, 'num', 0);
                }

            });

        }
    });
</script>

</html>